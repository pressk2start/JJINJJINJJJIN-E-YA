# 전체 코드 점검 & 승률 분석 리포트

**점검일**: 2026-02-13
**대상 파일**: `251130-MADEIT에서 여러수정보완한 찐찐찐이야야` (8,609줄)
**전략 유형**: 업비트 KRW 마켓 24시간 자동매매 봇 (스캘핑/모멘텀)

---

## 1. 승률 예측

### 현재 추정 승률: **30~38%**

#### 근거:

| 항목 | 값 | 영향 |
|------|------|------|
| 기존 데이터 (코드 주석 line 3035) | 32% (50건 기준) | 실측 기준선 |
| SL (손절폭) | 0.6~1.0% | 노이즈 손절 감소 효과 (+) |
| TP (익절) R:R 연동 | SL x 1.3~2.0 = 0.78~2.0% | 합리적 R:R (+) |
| 왕복 수수료 | 0.1% | 수익 0.1% 감소 |
| 가중점수 Gate (60점제) | AND 20개 -> 유연 필터 | 진입 기회 증가 (+) |
| Pullback Entry | 0.15~0.3% 진입가 개선 | 이론적 (+) 실전 불확실 |
| 디바운스 3회/6초 | 휩쏘 손절 감소 | 승률 개선 (+) |

#### 손익분기점 분석:

```
[현재 설정 기반]
- 평균 SL: 0.6% (DYN_SL_MIN)
- 평균 TP: 0.9% (SL x 1.5, 기본 경로)
- 수수료: 0.1% (왕복)
- 슬리피지: ~0.13% (진입 0.05% + 청산 0.08%)

손익분기 승률 = (SL + 수수료 + 슬리피지) / (TP + SL)
            = (0.6 + 0.1 + 0.13) / (0.9 + 0.6)
            = 0.83 / 1.5
            = 55.3%

현재 32~38% << 손익분기 55.3%
```

**결론: 현재 파라미터로는 장기적으로 손실 구조**

MFE x2.0 (점화 경로) R:R이 적용되면:
```
손익분기 = (0.6 + 0.23) / (1.2 + 0.6) = 46.1%
```
점화 경로에서도 46% 필요한데 현재 32~38%로는 부족합니다.

---

## 2. 핵심 문제점 (승률 훼손 원인)

### [P1] 진입 타이밍: 모멘텀 감지 = 이미 늦음 (가장 큰 문제)

**현상**: 거래량 급증 + 가격 상승 감지 후 진입 -> 이미 초기 상승의 60~80% 소진
**영향**: 매수 시 이미 고점 근처 -> 소폭 눌림에도 SL 히트

- `detect_leader_stock()`: 1분봉 기반 분석 -> 최소 1분 지연
- `stage1_gate()` 통과까지 여러 지표 확인 -> 추가 1~2초
- `postcheck_6s()`: 최대 6초 추가 대기
- `Pullback Entry`: 최대 20초 추가 대기
- **총 신호~체결 지연: 30~60초** (이 시간에 급등주는 이미 피크)

### [P2] 필터 개수 과다 -> 진짜 기회 놓침

9개 하드컷 + 4개 가중점수 + 킬러조건 + 포스트체크 + 가격가드 + 레짐필터
- 필터 하나만 걸려도 탈락 -> 좋은 셋업이 과도 필터링
- 예: 스프레드 0.26%인데 eff_spread_max=0.25% -> 0.01% 차이로 컷
- `GATE_OVERHEAT_MAX=20`: 합리적이지만 강세장에서 모든 급등 차단 가능

### [P3] SL 0.6% vs 크립토 변동성 불일치

- 1분봉 기준 BTC 평균 변동폭 0.3~0.5%, 알트코인 0.5~1.5%
- SL 0.6%는 알트코인의 **정상 1분 노이즈** 범위 내
- 진입 후 정상 눌림(-0.3~0.5%)에 SL 히트 -> 그 후 원래 방향으로 상승

### [P4] 풀백 진입 로직의 역효과

```python
PULLBACK_WAIT_SEC = 20      # 최대 20초 대기
PULLBACK_MIN_DIP = 0.0015   # 0.15% 하락 필요
PULLBACK_MAX_DIP = 0.008    # 0.8% 이상이면 포기
```

**문제**:
- 강한 모멘텀(진짜 기회) -> 풀백 없이 계속 상승 -> 20초 대기 후 더 높은 가격에 매수
- 약한 모멘텀(가짜 돌파) -> 풀백 발생 -> 매수 후 추가 하락
- 즉, 좋은 셋업은 못 잡고 나쁜 셋업만 잡는 역선택 구조

### [P5] 부분익절(50%) 후 잔여 포지션 관리 미흡

- MFE 도달 -> 50% 익절 -> 나머지 50%는 트레일링
- 트레일 거리 0.3%(SL x 0.5) -> 소폭 눌림에 잔여 50%도 청산
- **결과**: 수익의 대부분을 첫 50% 청산에서 확보, 나머지 50%는 거의 손실

---

## 3. 버그/리스크 점검

### [B1] 크리티컬: `_c1_cache` 캐시 10초 -> stale 데이터로 판단

```python
# line 6915
if _c1_cache is None or (now - _c1_cache_ts) >= 10:
    _c1_cache = get_minutes_candles(1, m, 20)
```

**문제**: 트레일링 업데이트, 래칫 계산, 컨텍스트 청산 등 모두 10초 된 데이터로 판단.
급등주에서 10초 = 2~5% 변동 가능.

### [B2] 하이: Pullback 루프 중 포지션 락 미보유

```python
# line 1451~1498
while time.time() - _pb_start < PULLBACK_WAIT_SEC:
    _pb_ticks = get_recent_ticks(m, 30, allow_network=True)
    ...
```

풀백 대기 20초 동안 `_POSITION_LOCK` 미보유 -> 다른 스레드가 동일 종목 처리 가능.
단, `entry_lock`으로 보호되므로 실질적 중복진입 위험은 낮음.

### [B3] 하이: `record_trade` 함수와 `update_trade_result` 에서 streak 이중 업데이트 가능성

주석(line 3450~3452)에 "record_trade()에서만" 이라고 되어있으나,
`update_trade_result`도 `_lose_streak` 값을 참조하여 학습 트리거 결정.
만약 `record_trade()`의 streak 업데이트와 타이밍이 어긋나면 잘못된 트리거 가능.

### [B4] 미디엄: 메인 루프 health.log 경로 하드코딩

```python
# line 7999
with open("/home/ubuntu/bot/health.log", "w") as hf:
```

배포 환경이 `/home/ubuntu/bot/`이 아닌 경우 매 루프마다 예외 발생.
`try/except`로 감싸져 있어 봇은 죽지 않지만 불필요한 오류.

### [B5] 미디엄: ThreadPoolExecutor 워커 12개 + 포지션당 모니터 스레드

최대 8 포지션 x 각 모니터 스레드 + 12 워커 + 3 워치독 = ~23 스레드.
GIL 경합 + API 429 위험 증가.

---

## 4. 개선 권고 (우선순위순)

### [개선1] R:R 구조 근본 개선 (영향: 최대)

**현재 문제**: 승률 32~38%에서 TP/SL 비율 1.5:1 -> 기대값 음수

**해결책 A - SL 확대 + TP 확대**:
```
SL: 0.6% -> 1.2% (2분봉 노이즈 이상)
TP: SL x 2.5 = 3.0% (점화), SL x 2.0 = 2.4% (강돌파)
손익분기 = (1.2 + 0.23) / (2.4 + 1.2) = 39.7%
```
- 노이즈 손절 대폭 감소 -> 승률 40%+ 기대
- 더 큰 움직임만 잡되, 잡으면 확실한 수익

**해결책 B - 진입 빈도 줄이고 확실한 것만**:
```
GATE_SCORE_THRESHOLD: 60 -> 75
킬러조건 4/6 이상만 진입
-> 진입 횟수 -50%, 승률 +15~20%p 기대
```

### [개선2] Pullback Entry 제거 또는 축소 (영향: 중)

**현재**: 20초 대기 -> 역선택 문제
**권고**: 제거하거나 5초 이내로 단축

```python
# 변경안
PULLBACK_WAIT_SEC = 5       # 20 -> 5초
PULLBACK_MIN_DIP = 0.001    # 0.15% -> 0.1%
```

또는 완전 제거하고 즉시 시장가 매수 (모멘텀 스캘핑의 기본 원칙).

### [개선3] 포스트체크 6초 제거 (영향: 중)

`POSTCHECK_ENABLED = False`로 이미 비활성화 상태이므로 실질적 영향은 없으나,
점화/강돌파가 아닌 일반 경로에서 6초 포스트체크는 좋은 진입을 놓치는 원인.

**현재 코드 확인**: line 6313에서 `POSTCHECK_ENABLED=False`이면 무조건 스킵.
이 설정은 올바르게 유지하되, 추후 활성화 시 주의 필요.

### [개선4] 1분봉 캐시 stale 문제 해결 (영향: 중)

```python
# 현재: 10초 캐시
if _c1_cache is None or (now - _c1_cache_ts) >= 10:

# 권고: 5초로 단축 (API 부담은 ticker throttle에서 이미 관리)
if _c1_cache is None or (now - _c1_cache_ts) >= 5:
```

또는 트레일링/래칫 판단 시에만 강제 갱신하는 로직 추가.

### [개선5] SL-TP 비율 및 트레일 구조 개선 (영향: 높음)

```python
# 현재
DYN_SL_MIN = 0.006        # 0.6%
DYN_SL_MAX = 0.010        # 1.0%
TRAIL_DISTANCE_MIN_BASE = 0.003  # 0.3%

# 권고: 알트코인 변동성에 맞게
DYN_SL_MIN = 0.010        # 1.0% (최소)
DYN_SL_MAX = 0.018        # 1.8% (최대)
TRAIL_DISTANCE_MIN_BASE = 0.005  # 0.5%
```

이렇게 하면:
- 노이즈 손절 대폭 감소 (가장 큰 승률 훼손 원인 제거)
- TP는 SL x 1.5 = 1.5~2.7% -> R:R 유지
- 트레일도 0.5%로 넓혀서 정상 눌림 허용

### [개선6] 진입-체결 지연 최소화 (영향: 중)

```
현재 흐름: 감지 -> gate -> postcheck -> pullback -> guard -> 매수
         |--- 30~60초 ---|

권고 흐름: 감지 -> gate -> 즉시 매수 -> (사후 검증 실패 시 즉시 청산)
         |--- 3~5초 ---|
```

"먼저 매수하고 틀리면 바로 잘라라"가 모멘텀 스캘핑의 핵심.
현재는 "충분히 확인하고 매수"하는데, 확인이 끝나면 이미 늦음.

### [개선7] 학습 시스템 개선 (영향: 낮음~중)

현재 학습은 GATE 임계치만 조절. 그러나 핵심 문제는 임계치가 아니라 구조(진입 지연, SL 크기).

**권고 추가 학습 대상**:
- SL 크기 (DYN_SL_MIN/MAX)
- 트레일 거리 (TRAIL_DISTANCE_MIN_BASE)
- 풀백 대기 시간 (PULLBACK_WAIT_SEC)
- MFE 부분익절 비율 (MFE_PARTIAL_RATIO)

---

## 5. 코드 품질 문제 (운영 안정성)

| 항목 | 등급 | 설명 |
|------|------|------|
| 단일 파일 8,609줄 | C | 유지보수 극히 어려움, 모듈 분리 시급 |
| 전역 변수 50+개 | C+ | 상태 추적 어려움, 클래스 캡슐화 필요 |
| health.log 하드코딩 | B- | 환경별 설정 필요 |
| 이모지 주석 과다 | B- | grep/검색 노이즈 |
| 에러 핸들링 | B+ | 실전 경험 기반의 견고한 방어 코드 |
| 동시성 안전 | B+ | 락 시스템 체계적, TTL 불일치만 주의 |

---

## 6. 최종 종합 판정

| 영역 | 등급 | 설명 |
|------|------|------|
| 전략 설계 | C+ | 모멘텀 추종 but 진입 지연으로 역효과 |
| 리스크 관리 | B | 연패 제어, 포지션 사이징 양호. SL 크기 부족 |
| 코드 완성도 | B+ | 실전 경험 기반 견고, 엣지 케이스 대응 충실 |
| 기대 승률 | **30~38%** | 손익분기(~55%) 미달, 현재 파라미터로는 장기 손실 |
| 기대 기대값 | **-0.1~-0.2%/거래** | 수수료+슬리피지 감안 시 음의 기대값 |

### 핵심 메시지

> **필터(진입 조건)의 문제가 아니라 구조(진입 지연 + SL 크기)의 문제입니다.**
>
> 현재 봇은 "정확한 진입"을 추구하며 30~60초를 검증에 씀.
> 그러나 모멘텀 스캘핑에서 30초 지연 = 이미 늦은 진입.
>
> 개선 우선순위:
> 1. **SL 1.0%+ 로 확대** (노이즈 손절 제거, 즉시 효과)
> 2. **풀백 로직 제거** (역선택 제거)
> 3. **TP를 SL x 2.0+ 로 확대** (R:R 개선으로 낮은 승률 보완)
> 4. 검증 축소 -> 빠른 진입 (사후 청산으로 전환)

---

*생성: Claude Code 전체 코드 점검 (2026-02-13)*
